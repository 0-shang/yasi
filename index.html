<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">
    <title>我的单词本</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f3f4f6;
            --surface: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* 底部导航 */
        .tab-bar {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            padding: 10px 0 calc(10px + var(--safe-bottom));
            position: fixed; bottom: 0; width: 100%; z-index: 100;
        }
        .tab-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sub); font-size: 10px; gap: 4px; cursor: pointer; transition: 0.2s; }
        .tab-item i { font-size: 24px; }
        .tab-item.active { color: var(--primary); transform: scale(1.1); }

        /* 主视口 */
        .viewport { flex: 1; overflow-y: auto; padding-bottom: 80px; position: relative; }

        /* 页面：书架 */
        .page-library { padding: 20px; }
        .page-header { margin-bottom: 20px; }
        .page-title { font-size: 24px; font-weight: 800; }
        .page-subtitle { font-size: 13px; color: var(--text-sub); margin-top: 5px; }

        .book-card {
            background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); display: flex; align-items: center; justify-content: space-between;
            border: 2px solid transparent; transition: 0.2s;
        }
        .book-card:active { transform: scale(0.98); }
        .book-card.active-book { border-color: var(--primary); background: #eef2ff; }
        .book-meta h3 { margin: 0 0 5px 0; font-size: 17px; }
        .book-meta p { margin: 0; font-size: 13px; color: var(--text-sub); }
        
        .upload-zone {
            border: 2px dashed #cbd5e1; border-radius: 16px; padding: 25px; text-align: center;
            color: var(--text-sub); margin-top: 30px; cursor: pointer; background: white;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }

        /* 页面：学习 */
        .page-study { height: 100%; display: flex; flex-direction: column; padding: 20px; }
        .progress-indicator { 
            display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 12px; color: var(--text-sub); font-weight: bold;
        }
        
        .flashcard {
            flex: 1; width: 100%; max-width: 600px; margin: 0 auto; background: white; border-radius: 24px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1); position: relative;
            transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer; max-height: 65vh;
        }
        .flashcard.flipped { transform: rotateY(180deg); }
        
        .face {
            position: absolute; top:0; left:0; width: 100%; height: 100%; backface-visibility: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px 30px; border-radius: 24px; box-sizing: border-box;
        }
        
        /* 正面 */
        .front { background: white; z-index: 2; }
        .word-text { font-size: 48px; font-weight: 800; color: var(--text-main); margin-bottom: 10px; text-align: center; line-height: 1.1; }
        .tap-hint { font-size: 13px; color: #9ca3af; margin-top: 30px; animation: pulse 2s infinite; }
        
        /* 背面 */
        .back { transform: rotateY(180deg); background: #fff; align-items: flex-start; justify-content: flex-start; overflow-y: auto; text-align: left; }
        .word-small { font-size: 24px; font-weight: bold; color: var(--primary); margin-bottom: 20px; border-bottom: 1px solid #eee; width: 100%; padding-bottom: 10px; }
        .meaning-text { 
            font-size: 20px; line-height: 1.6; color: #374151; white-space: pre-wrap; 
            border-left: 4px solid var(--primary); padding-left: 15px; margin-bottom: 20px;
        }

        /* 动作按钮 */
        .action-container { 
            width: 100%; max-width: 600px; margin: 20px auto 0; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; height: 64px;
        }
        .btn {
            border: none; border-radius: 14px; font-weight: bold; color: white; font-size: 15px;
            cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.1s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn:active { transform: scale(0.95); }
        .btn span { font-size: 10px; opacity: 0.85; margin-top: 2px; font-weight: normal; }
        
        .btn-1 { background: #ef4444; } 
        .btn-2 { background: #f59e0b; } 
        .btn-3 { background: #10b981; } 
        .btn-4 { background: #3b82f6; } 

        /* 统计页 */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card { background: white; padding: 25px 20px; border-radius: 16px; text-align: center; }
        .stat-val { font-size: 32px; font-weight: 900; color: var(--text-main); display: block; margin-bottom: 5px; }
        .stat-label { font-size: 13px; color: var(--text-sub); }

        /* 动画 */
        @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }
    </style>
</head>
<body>
    <div id="app">
        <!-- 主视口 -->
        <div class="viewport">
            
            <!-- 1. 学习页面 -->
            <div v-if="currentTab === 'study'" class="page-study">
                <!-- 无书状态 -->
                <div v-if="!currentBookId" style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; color:#9ca3af;">
                    <i class="ri-book-open-line" style="font-size: 80px; margin-bottom: 20px; opacity: 0.5;"></i>
                    <p>请先在“书架”导入并选择一本书</p>
                    <button @click="currentTab='library'" style="margin-top:20px; padding:12px 30px; background:var(--primary); color:white; border:none; border-radius:20px; font-size:16px;">去书架</button>
                </div>

                <!-- 任务完成 -->
                <div v-else-if="todayQueue.length === 0" style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                    <div style="background:#d1fae5; width:100px; height:100px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom:20px;">
                        <i class="ri-check-line" style="font-size: 50px; color: #10b981;"></i>
                    </div>
                    <h2 style="margin:0 0 10px 0;">太棒了！</h2>
                    <p style="color:var(--text-sub)">今日复习任务已全部完成</p>
                </div>

                <!-- 背词卡片 -->
                <template v-else>
                    <div class="progress-indicator">
                        <span>待复习: {{ todayQueue.length }}</span>
                        <span>{{ currentBookName }}</span>
                    </div>

                    <div class="flashcard" :class="{flipped: isFlipped}" @click="flipCard">
                        <!-- 正面 -->
                        <div class="face front">
                            <div class="word-text">{{ currentWord.word }}</div>
                            <div class="tap-hint">点击查看释义</div>
                        </div>
                        <!-- 背面 -->
                        <div class="face back">
                            <div class="word-small">{{ currentWord.word }}</div>
                            <div class="meaning-text">{{ currentWord.meaning }}</div>
                        </div>
                    </div>

                    <!-- 只有翻面后才显示按钮 -->
                    <div class="action-container" v-if="isFlipped">
                        <button class="btn btn-1" @click.stop="rate(1)">忘记<span>1分钟</span></button>
                        <button class="btn btn-2" @click.stop="rate(2)">模糊<span>10分钟</span></button>
                        <button class="btn btn-3" @click.stop="rate(3)">认识<span>1天</span></button>
                        <button class="btn btn-4" @click.stop="rate(4)">简单<span>4天</span></button>
                    </div>
                    <!-- 占位符保持布局稳定 -->
                    <div class="action-container" v-else style="visibility:hidden"></div>
                </template>
            </div>

            <!-- 2. 书架页面 -->
            <div v-if="currentTab === 'library'" class="page-library">
                <div class="page-header">
                    <div class="page-title">我的书架</div>
                    <div class="page-subtitle">管理你的单词书和进度</div>
                </div>

                <div v-for="book in books" :key="book.id" 
                     class="book-card" :class="{'active-book': currentBookId === book.id}"
                     @click="switchBook(book.id)">
                    <div style="display:flex; align-items:center">
                        <div style="background:#f3f4f6; width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-right:15px;">
                            <i class="ri-book-2-fill" style="color:var(--primary); font-size:24px;"></i>
                        </div>
                        <div class="book-meta">
                            <h3>{{ book.name }}</h3>
                            <p>{{ book.count }} 词 · 进度 {{ getProgress(book.id) }}%</p>
                        </div>
                    </div>
                    <i v-if="currentBookId === book.id" class="ri-checkbox-circle-fill" style="color:var(--primary); font-size:24px"></i>
                    <i v-else class="ri-delete-bin-line" @click.stop="deleteBook(book.id)" style="color:#ef4444; opacity:0.3; padding:10px"></i>
                </div>

                <div class="upload-zone" @click="$refs.fileInput.click()">
                    <i class="ri-file-add-line" style="font-size:36px; color:#9ca3af"></i>
                    <div style="font-weight:bold; color:#4b5563">导入 CSV 单词书</div>
                    <div style="font-size:12px">支持格式：单词,意思 (逗号分隔)</div>
                </div>
                <input type="file" ref="fileInput" accept=".csv" style="display:none" @change="handleCSVImport">
            </div>

            <!-- 3. 数据页面 -->
            <div v-if="currentTab === 'stats'" class="page-library">
                <div class="page-header">
                    <div class="page-title">学习数据</div>
                </div>
                
                <div class="stat-grid" v-if="currentBookId">
                    <div class="stat-card">
                        <span class="stat-val">{{ stats.learned }}</span>
                        <span class="stat-label">已掌握单词</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-val">{{ stats.due }}</span>
                        <span class="stat-label">今日待复习</span>
                    </div>
                    <div class="stat-card" style="grid-column: span 2">
                        <span class="stat-val">{{ stats.total }}</span>
                        <span class="stat-label">本书总词汇量</span>
                    </div>
                </div>
                <div v-else style="text-align:center; padding-top:100px; color:#9ca3af;">
                    请先选择一本书
                </div>
            </div>
        </div>

        <!-- 底部导航 -->
        <div class="tab-bar">
            <div class="tab-item" :class="{active: currentTab==='study'}" @click="currentTab='study'">
                <i class="ri-brain-line"></i>
                <span>学习</span>
            </div>
            <div class="tab-item" :class="{active: currentTab==='library'}" @click="currentTab='library'">
                <i class="ri-book-read-line"></i>
                <span>书架</span>
            </div>
            <div class="tab-item" :class="{active: currentTab==='stats'}" @click="currentTab='stats'">
                <i class="ri-bar-chart-box-line"></i>
                <span>数据</span>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;
        
        // 数据库配置
        const DB_NAME = 'WordMasterPro_CSV';
        const DB_VERSION = 1;

        // 打开数据库
        const openDB = () => {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('books')) db.createObjectStore('books', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('progress')) db.createObjectStore('progress', { keyPath: 'key' });
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        };

        createApp({
            setup() {
                const currentTab = ref('study');
                const books = ref([]);
                const currentBookId = ref(localStorage.getItem('wm_curr_book') || null);
                const currentBookName = ref('');
                const wordList = ref([]); // 当前书单词表
                const progressMap = ref({}); // 进度缓存
                const todayQueue = ref([]);
                const currentWord = ref(null);
                const isFlipped = ref(false);
                let db = null;

                onMounted(async () => {
                    db = await openDB();
                    loadBooks();
                    if (currentBookId.value) loadBookData(currentBookId.value);
                });

                // --- 核心功能：CSV 解析与导入 ---
                const handleCSVImport = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const text = e.target.result;
                        const lines = text.split(/\r\n|\n/);
                        const words = [];
                        
                        lines.forEach((line, index) => {
                            if (!line.trim()) return; // 跳过空行
                            
                            // 简单 CSV 解析：按第一个逗号分隔
                            // 如果你的 CSV 包含英文逗号在意思里，这行逻辑通常也能工作，因为我们只切分第一个逗号
                            const firstCommaIndex = line.indexOf(',');
                            if (firstCommaIndex === -1) return; 

                            const word = line.substring(0, firstCommaIndex).trim();
                            // 去掉意思周围可能的引号
                            let meaning = line.substring(firstCommaIndex + 1).trim();
                            if (meaning.startsWith('"') && meaning.endsWith('"')) {
                                meaning = meaning.slice(1, -1);
                            }
                            
                            // 过滤表头（如果第一行是 Word,Meaning）
                            if (index === 0 && (word.toLowerCase() === 'word' || word === '单词')) return;

                            if (word && meaning) {
                                words.push({ id: word.toLowerCase(), word, meaning });
                            }
                        });

                        if (words.length === 0) {
                            alert('未识别到单词，请检查 CSV 格式 (例如: apple,苹果)');
                            return;
                        }

                        // 存入数据库
                        const bookId = Date.now().toString();
                        const newBook = {
                            id: bookId,
                            name: file.name.replace('.csv', ''),
                            count: words.length,
                            words: words
                        };

                        const tx = db.transaction('books', 'readwrite');
                        tx.objectStore('books').put(newBook);
                        tx.oncomplete = () => {
                            loadBooks();
                            switchBook(bookId);
                            currentTab.value = 'study';
                            alert(`成功导入 ${words.length} 个单词！`);
                        };
                    };
                    reader.readAsText(file); // 默认 UTF-8，如果乱码可改为 'gbk'
                };

                // --- 业务逻辑 ---
                const loadBooks = () => {
                    const tx = db.transaction('books', 'readonly');
                    tx.objectStore('books').getAll().onsuccess = (e) => {
                        books.value = e.target.result;
                    };
                };

                const switchBook = (id) => {
                    currentBookId.value = id;
                    localStorage.setItem('wm_curr_book', id);
                    loadBookData(id);
                };

                const loadBookData = (id) => {
                    const tx = db.transaction(['books', 'progress'], 'readonly');
                    
                    // 获取书名和单词
                    tx.objectStore('books').get(id).onsuccess = (e) => {
                        const res = e.target.result;
                        if (res) {
                            currentBookName.value = res.name;
                            wordList.value = res.words;
                            generateQueue();
                        }
                    };

                    // 获取进度
                    tx.objectStore('progress').getAll().onsuccess = (e) => {
                        const all = e.target.result;
                        // 筛选当前书的进度
                        const map = {};
                        all.forEach(p => {
                            if (p.key.startsWith(id + '_')) map[p.wid] = p;
                        });
                        progressMap.value = map;
                        generateQueue(); // 进度加载完再生成一次队列，确保准确
                    };
                };

                const deleteBook = (id) => {
                    if(!confirm('确定删除这本书吗？进度也会丢失。')) return;
                    const tx = db.transaction('books', 'readwrite');
                    tx.objectStore('books').delete(id);
                    tx.oncomplete = () => {
                        loadBooks();
                        if (currentBookId.value === id) {
                            currentBookId.value = null;
                            wordList.value = [];
                            todayQueue.value = [];
                            currentWord.value = null;
                        }
                    };
                };

                // 艾宾浩斯核心逻辑
                const generateQueue = () => {
                    if (!wordList.value.length) return;
                    
                    const now = Date.now();
                    const newWords = [];
                    const reviewWords = [];

                    wordList.value.forEach(w => {
                        const p = progressMap.value[w.id];
                        if (!p) {
                            newWords.push(w);
                        } else if (p.due <= now) {
                            reviewWords.push(w);
                        }
                    });

                    // 每日计划：优先复习，再学新词 (这里设限 30 个防止压力过大)
                    todayQueue.value = [...reviewWords, ...newWords.slice(0, 20)].slice(0, 50);
                    
                    if (todayQueue.value.length > 0) {
                        currentWord.value = todayQueue.value[0];
                        isFlipped.value = false;
                    }
                };

                const rate = (quality) => {
                    const w = currentWord.value;
                    const pid = w.id;
                    let p = progressMap.value[pid] || { interval: 0, reps: 0, ef: 2.5 };

                    // SM-2 算法
                    if (quality < 3) {
                        p.reps = 0;
                        p.interval = 1; 
                    } else {
                        if (p.reps === 0) p.interval = 1;
                        else if (p.reps === 1) p.interval = 6;
                        else p.interval = Math.round(p.interval * p.ef);
                        
                        p.reps++;
                        p.ef = p.ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                        if (p.ef < 1.3) p.ef = 1.3;
                    }

                    // 计算下次复习时间 (毫秒)
                    // 演示模式：1天=真正1天。如果需要测试，可把 24*60*60 改小
                    let nextDue = Date.now();
                    if (quality < 3) {
                        nextDue += 60 * 1000; // 1分钟后
                    } else {
                        // 简单映射按钮到天数
                        const days = [0, 0, 0, 1, 4]; // 对应 btn 1,2,3,4
                        let dayAdd = quality >= 3 ? p.interval : 0;
                        nextDue += dayAdd * 24 * 60 * 60 * 1000;
                    }

                    const record = { 
                        key: currentBookId.value + '_' + pid, 
                        wid: pid, 
                        due: nextDue, 
                        ...p 
                    };

                    // 更新数据库
                    const tx = db.transaction('progress', 'readwrite');
                    tx.objectStore('progress').put(record);
                    
                    // 更新内存
                    progressMap.value[pid] = record;

                    // UI 逻辑
                    isFlipped.value = false;
                    todayQueue.value.shift(); // 移除当前
                    
                    if (quality < 3) {
                        // 如果不认识，放到队尾待会儿再背
                        todayQueue.value.push(w);
                    }

                    if (todayQueue.value.length > 0) {
                        currentWord.value = todayQueue.value[0];
                    }
                };

                const flipCard = () => {
                    isFlipped.value = !isFlipped.value;
                    if(isFlipped.value) {
                         const u = new SpeechSynthesisUtterance(currentWord.value.word);
                         window.speechSynthesis.speak(u);
                    }
                };

                // 辅助数据
                const getProgress = (bookId) => {
                    // 由于progressMap只存当前书，这里粗略计算
                    // 实际应该遍历数据库，这里为了性能简化：如果是当前书显示实时，否则显示0 (或需复杂查询)
                    if (bookId === currentBookId.value && wordList.value.length) {
                        const learned = Object.keys(progressMap.value).length;
                        return Math.round((learned / wordList.value.length) * 100);
                    }
                    return 0; // 简化处理
                };

                const stats = computed(() => {
                    const total = wordList.value.length || 0;
                    const learned = Object.keys(progressMap.value).length || 0;
                    return {
                        total,
                        learned,
                        due: todayQueue.value.length,
                        percent: total ? Math.round((learned/total)*100) : 0
                    };
                });

                return {
                    currentTab, books, currentBookId, currentBookName, todayQueue, currentWord, isFlipped, stats,
                    handleCSVImport, switchBook, deleteBook, flipCard, rate, getProgress
                };
            }
        }).mount('#app');
        
        // 注册 Service Worker 实现 PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }
    </script>
</body>
</html>