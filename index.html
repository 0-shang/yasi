<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 核心：禁止缩放，适配刘海屏，全屏显示 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA 标准配置 -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#ffffff">
    
    <!-- iOS 专用配置 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="背词神器">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2232/2232688.png">

    <title>背词神器</title>
    
    <!-- 引入资源 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #007AFF;
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --text-main: #000000;
            --text-sub: #8E8E93;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            height: 100vh; height: 100dvh;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        #app { height: 100%; display: flex; flex-direction: column; width: 100%; }

        /* 顶部导航 */
        .header {
            padding-top: var(--safe-top);
            height: calc(44px + var(--safe-top));
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 17px;
            border-bottom: 0.5px solid rgba(0,0,0,0.1);
            position: fixed; top: 0; width: 100%; z-index: 10;
        }
        .header-icon { position: absolute; right: 15px; top: calc(var(--safe-top) + 10px); font-size: 22px; color: var(--primary); }

        /* 主内容区 */
        .viewport {
            flex: 1; overflow-y: auto; 
            padding: calc(44px + var(--safe-top) + 15px) 15px 80px 15px;
            -webkit-overflow-scrolling: touch;
        }

        /* --- 学习页面 --- */
        .study-card {
            background: var(--card); border-radius: 16px; padding: 40px 20px;
            box-shadow: var(--shadow); min-height: 50vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.2s; position: relative;
        }
        
        .word-title { font-size: 42px; font-weight: 800; text-align: center; margin-bottom: 10px; line-height: 1.1; }
        .tap-tip { font-size: 14px; color: var(--primary); background: #eef5ff; padding: 6px 12px; border-radius: 20px; margin-top: 20px; }
        
        /* 释义区域 (点击后出现) */
        .meaning-area {
            width: 100%; margin-top: 30px; padding-top: 25px; border-top: 1px solid #f0f0f0;
            text-align: left; animation: slideDown 0.3s ease;
        }
        .meaning-text { font-size: 18px; line-height: 1.6; color: #333; }

        /* 底部按钮 (固定) */
        .action-bar {
            position: fixed; bottom: calc(60px + var(--safe-bottom)); left: 15px; right: 15px;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; z-index: 20;
        }
        .btn {
            border: none; height: 56px; border-radius: 12px; color: white; font-weight: 600; font-size: 16px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); cursor: pointer;
        }
        .btn:active { transform: scale(0.96); }
        .btn span { font-size: 10px; font-weight: normal; opacity: 0.9; margin-top: 2px; }
        
        .bg-red { background: #FF3B30; }
        .bg-orange { background: #FF9500; }
        .bg-green { background: #34C759; }
        .bg-blue { background: #007AFF; }

        /* --- 书架页面 --- */
        .stat-board {
            display: flex; gap: 10px; margin-bottom: 20px;
        }
        .stat-box { flex: 1; background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: var(--shadow); }
        .stat-val { display: block; font-size: 24px; font-weight: 800; color: var(--text-main); margin-bottom: 4px; }
        .stat-lbl { font-size: 11px; color: var(--text-sub); }

        .book-item {
            background: white; padding: 18px; border-radius: 14px; margin-bottom: 12px;
            display: flex; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative;
        }
        .book-item.active { border: 2px solid var(--primary); background: #f5f9ff; }
        .book-icon { font-size: 28px; color: var(--primary); margin-right: 15px; }
        .book-info h3 { margin: 0 0 4px; font-size: 16px; }
        .book-info p { margin: 0; font-size: 12px; color: var(--text-sub); }
        
        .upload-box {
            margin-top: 20px; border: 2px dashed #C6C6C8; border-radius: 14px; padding: 20px;
            text-align: center; color: var(--text-sub); background: white;
        }

        /* 底部导航 Tab */
        .tab-bar {
            position: fixed; bottom: 0; width: 100%; height: calc(50px + var(--safe-bottom));
            background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.15);
            display: flex; padding-bottom: var(--safe-bottom); z-index: 50;
        }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 10px; }
        .tab-item i { font-size: 24px; margin-bottom: 2px; }
        .tab-item.active { color: var(--primary); }

        /* 空状态 */
        .empty { text-align: center; margin-top: 30%; color: var(--text-sub); }
        .empty-btn { margin-top: 20px; padding: 10px 24px; background: var(--primary); color: white; border: none; border-radius: 20px; font-size: 15px; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="app">
        <!-- 标题栏 -->
        <div class="header">
            <span>{{ pageTitle }}</span>
            <i v-if="currentTab==='library'" class="ri-settings-3-line header-icon" @click="setLimit"></i>
        </div>

        <!-- 滚动视图 -->
        <div class="viewport">
            
            <!-- 1. 学习页 -->
            <div v-if="currentTab === 'study'">
                <!-- 情况A：没选书 -->
                <div v-if="!currentBookId" class="empty">
                    <i class="ri-book-open-line" style="font-size: 64px; opacity: 0.3;"></i>
                    <p>请先到书架选择一本书</p>
                    <button class="empty-btn" @click="currentTab='library'">去书架</button>
                </div>

                <!-- 情况B：今日完成 -->
                <div v-else-if="todayQueue.length === 0" class="empty">
                    <div style="background:#e8f5e9; width:80px; height:80px; border-radius:50%; margin:0 auto 20px; display:flex; align-items:center; justify-content:center;">
                        <i class="ri-check-line" style="font-size: 40px; color: #34C759;"></i>
                    </div>
                    <h3>今日任务完成</h3>
                    <p>休息一下，明天继续！</p>
                </div>

                <!-- 情况C：背单词 -->
                <div v-else class="study-card" @click="reveal">
                    <div style="position:absolute; top:15px; right:15px; font-size:12px; color:#999; font-weight:bold">
                        {{ queueType }}
                    </div>
                    <div class="word-title">{{ currentWord.word }}</div>
                    
                    <!-- 提示语（未展开时） -->
                    <div v-if="!isRevealed" class="tap-tip">点击查看释义</div>

                    <!-- 释义区（展开后） -->
                    <div v-if="isRevealed" class="meaning-area">
                        <div class="meaning-text">{{ currentWord.meaning }}</div>
                    </div>
                </div>
            </div>

            <!-- 2. 书架页 -->
            <div v-if="currentTab === 'library'">
                <div class="stat-board">
                    <div class="stat-box">
                        <span class="stat-val" style="color:var(--primary)">{{ todayLearned }}</span>
                        <span class="stat-lbl">今日新学</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-val" style="color:#FF9500">{{ dailyLimit }}</span>
                        <span class="stat-lbl">每日上限</span>
                    </div>
                </div>

                <div v-for="book in books" :key="book.id" 
                     class="book-item" :class="{active: currentBookId === book.id}"
                     @click="switchBook(book.id)">
                    <i class="ri-book-2-fill book-icon"></i>
                    <div class="book-info">
                        <h3>{{ book.name }}</h3>
                        <p>共 {{ book.total }} 词 · 待复习 {{ getDueCount(book.id) }}</p>
                    </div>
                    <i v-if="currentBookId === book.id" class="ri-checkbox-circle-fill" style="color:var(--primary); font-size:24px; position:absolute; right:15px"></i>
                    <i v-else class="ri-delete-bin-line" style="color:#ff3b30; opacity:0.5; position:absolute; right:15px; padding:10px" @click.stop="deleteBook(book.id)"></i>
                </div>

                <div class="upload-box" @click="$refs.csvInput.click()">
                    <i class="ri-add-line" style="font-size:24px; vertical-align:middle"></i> 
                    <span style="font-weight:600">导入 CSV 单词书</span>
                    <div style="font-size:12px; margin-top:5px; opacity:0.6">UTF-8 格式，无表头 (单词,意思)</div>
                </div>
                <input type="file" ref="csvInput" accept=".csv" style="display:none" @change="importCSV">
            </div>

        </div>

        <!-- 底部浮动操作栏 (仅在学习且展开时显示) -->
        <div class="action-bar" v-if="currentTab === 'study' && isRevealed && todayQueue.length > 0">
            <button class="btn bg-red" @click.stop="rate(1)">忘记<span>1m</span></button>
            <button class="btn bg-orange" @click.stop="rate(2)">模糊<span>10m</span></button>
            <button class="btn bg-green" @click.stop="rate(3)">认识<span>1d</span></button>
            <button class="btn bg-blue" @click.stop="rate(4)">简单<span>4d</span></button>
        </div>

        <!-- 底部导航栏 -->
        <div class="tab-bar">
            <div class="tab-item" :class="{active: currentTab==='study'}" @click="currentTab='study'">
                <i class="ri-macbook-line"></i><span>学习</span>
            </div>
            <div class="tab-item" :class="{active: currentTab==='library'}" @click="currentTab='library'">
                <i class="ri-book-read-line"></i><span>书架</span>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        const DB_NAME = 'VocabMaster_V5';
        
        // 数据库封装
        const openDB = () => new Promise((resolve) => {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = e => {
                const db = e.target.result;
                if(!db.objectStoreNames.contains('books')) db.createObjectStore('books', {keyPath: 'id'});
                if(!db.objectStoreNames.contains('progress')) db.createObjectStore('progress', {keyPath: 'key'});
                if(!db.objectStoreNames.contains('logs')) db.createObjectStore('logs', {keyPath: 'date'});
            };
            req.onsuccess = e => resolve(e.target.result);
        });

        createApp({
            setup() {
                const currentTab = ref('study');
                const db = ref(null);
                const books = ref([]);
                const currentBookId = ref(localStorage.getItem('vb_curr_book'));
                const currentBookName = ref('');
                
                const wordList = ref([]);
                const progressMap = ref({});
                const todayQueue = ref([]);
                const currentWord = ref(null);
                const isRevealed = ref(false); // 释义是否显示
                const dailyLimit = ref(parseInt(localStorage.getItem('vb_limit')) || 20);
                const todayLearned = ref(0);

                const pageTitle = computed(() => currentTab.value === 'study' ? (currentBookName.value || '开始学习') : '我的书架');
                const queueType = computed(() => {
                    if(!currentWord.value) return '';
                    const p = progressMap.value[currentWord.value.id];
                    return (p && p.level > 0) ? '复习' : '新词';
                });

                onMounted(async () => {
                    db.value = await openDB();
                    loadBooks();
                    loadDailyLog();
                    if(currentBookId.value) loadBookData(currentBookId.value);
                });

                // --- 业务逻辑 ---
                const importCSV = (e) => {
                    const file = e.target.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const text = ev.target.result;
                        // 兼容各种换行符
                        const lines = text.replace(/\r\n/g, '\n').split('\n');
                        const words = [];
                        lines.forEach(line => {
                            // 查找第一个逗号或中文逗号
                            let idx = line.indexOf(',');
                            if(idx === -1) idx = line.indexOf('，');
                            
                            if(idx > 0) {
                                const w = line.slice(0, idx).trim();
                                let m = line.slice(idx+1).trim().replace(/^"|"$/g, '');
                                if(w && m) words.push({ id: w.toLowerCase(), word: w, meaning: m });
                            }
                        });
                        
                        if(words.length === 0) return alert('无法识别内容，请检查CSV格式');
                        
                        const book = { id: Date.now().toString(), name: file.name.replace('.csv',''), total: words.length, words };
                        const tx = db.value.transaction('books', 'readwrite');
                        tx.objectStore('books').put(book);
                        tx.oncomplete = () => { loadBooks(); switchBook(book.id); alert('导入成功！'); };
                    };
                    reader.readAsText(file, 'UTF-8');
                };

                const loadBooks = () => {
                    db.value.transaction('books','readonly').objectStore('books').getAll().onsuccess = e => books.value = e.target.result || [];
                };

                const switchBook = (id) => {
                    currentBookId.value = id;
                    localStorage.setItem('vb_curr_book', id);
                    loadBookData(id);
                    currentTab.value = 'study';
                };

                const loadBookData = (id) => {
                    const tx = db.value.transaction(['books','progress'], 'readonly');
                    tx.objectStore('books').get(id).onsuccess = e => {
                        const res = e.target.result;
                        if(res) {
                            currentBookName.value = res.name;
                            wordList.value = res.words;
                            tx.objectStore('progress').getAll().onsuccess = ev => {
                                const all = ev.target.result || [];
                                const map = {};
                                all.forEach(p => { if(p.key.startsWith(id+'_')) map[p.wid] = p; });
                                progressMap.value = map;
                                generateQueue();
                            };
                        } else {
                            currentBookId.value = null; 
                        }
                    };
                };

                const generateQueue = () => {
                    const now = Date.now();
                    const reviews = [];
                    const news = [];
                    
                    wordList.value.forEach(w => {
                        const p = progressMap.value[w.id];
                        if (!p) {
                            if(news.length < (dailyLimit.value - todayLearned.value)) news.push(w);
                        } else if (p.due <= now) {
                            reviews.push(w);
                        }
                    });
                    
                    todayQueue.value = [...reviews, ...news];
                    loadNext();
                };

                const loadNext = () => {
                    if (todayQueue.value.length > 0) {
                        currentWord.value = todayQueue.value[0];
                        isRevealed.value = false;
                    } else {
                        currentWord.value = null;
                    }
                };

                // 点击展开释义
                const reveal = () => {
                    if(!isRevealed.value) {
                        isRevealed.value = true;
                        // 自动发音
                        const u = new SpeechSynthesisUtterance(currentWord.value.word);
                        u.lang = 'en-US';
                        window.speechSynthesis.speak(u);
                    }
                };

                // 艾宾浩斯/SM2 评分
                const rate = (q) => {
                    const w = currentWord.value;
                    const pid = w.id;
                    let p = progressMap.value[pid] || { interval: 0, reps: 0, ef: 2.5 };
                    const now = Date.now();

                    if (q < 3) { // 忘/模糊
                        p.reps = 0; p.interval = 1;
                    } else {
                        if (p.reps === 0) p.interval = 1;
                        else if (p.reps === 1) p.interval = 6;
                        else p.interval = Math.round(p.interval * p.ef);
                        p.reps++;
                        p.ef = Math.max(1.3, p.ef + (0.1 - (5-q)*(0.08+(5-q)*0.02)));
                    }

                    // 计算下次时间
                    let nextTime = now;
                    if(q === 1) nextTime += 60000; // 1m
                    else if(q === 2) nextTime += 600000; // 10m
                    else nextTime += (q>=3 ? p.interval : 0) * 86400000; // 天

                    // 记录今日新学
                    if (!progressMap.value[pid] && q >= 3) {
                        todayLearned.value++;
                        updateDailyLog();
                    }

                    const record = { key: `${currentBookId.value}_${pid}`, wid: pid, due: nextTime, ...p };
                    const tx = db.value.transaction('progress', 'readwrite');
                    tx.objectStore('progress').put(record);
                    progressMap.value[pid] = record;

                    todayQueue.value.shift();
                    if (q < 3) todayQueue.value.push(w); // 不熟的，放入队尾今天继续背
                    loadNext();
                };

                // 辅助功能
                const deleteBook = (id) => {
                    if(!confirm("确认删除？")) return;
                    const tx = db.value.transaction('books', 'readwrite');
                    tx.objectStore('books').delete(id);
                    tx.oncomplete = () => { 
                        if(currentBookId.value==id) currentBookId.value=null;
                        loadBooks(); 
                    };
                };

                const setLimit = () => {
                    const val = prompt("每日新词数量：", dailyLimit.value);
                    if(val) {
                        dailyLimit.value = parseInt(val);
                        localStorage.setItem('vb_limit', dailyLimit.value);
                        if(currentBookId.value) loadBookData(currentBookId.value);
                    }
                };

                const loadDailyLog = () => {
                    const date = new Date().toLocaleDateString();
                    // 这里简化处理，直接用 localStorage 存今日数据，避免复杂DB操作
                    todayLearned.value = parseInt(localStorage.getItem('log_'+date) || 0);
                };

                const updateDailyLog = () => {
                    const date = new Date().toLocaleDateString();
                    localStorage.setItem('log_'+date, todayLearned.value);
                };

                const getDueCount = (bookId) => {
                    // 仅供显示用，简单返回 '?'，因为需要遍历，性能消耗大
                    // 如果是当前书，可以精确显示
                    if(bookId === currentBookId.value) return todayQueue.value.length;
                    return '-';
                };

                return {
                    currentTab, books, currentBookId, currentBookName, todayQueue, currentWord, isRevealed,
                    dailyLimit, todayLearned, queueType,
                    importCSV, switchBook, deleteBook, reveal, rate, setLimit, getDueCount
                };
            }
        }).mount('#app');
        
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>