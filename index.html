<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f5f7fa">
    <title>背词神器</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        /* --- 1. 移动端专属设计系统 --- */
        :root {
            --primary: #5856d6;       /* iOS 风格蓝紫色 */
            --primary-bg: #eef1ff;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --info: #007aff;
            --bg: #f2f2f7;            /* iOS 背景灰 */
            --card-bg: #ffffff;
            --text-main: #000000;
            --text-sub: #8e8e93;
            --radius: 20px;
            --shadow: 0 8px 24px rgba(0,0,0,0.06);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --header-height: 50px;
            --tab-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            height: 100vh;
            height: 100dvh; /* 动态视口高度，解决手机地址栏跳动问题 */
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #app { height: 100%; display: flex; flex-direction: column; width: 100%; max-width: 600px; margin: 0 auto; position: relative; }

        /* --- 顶部栏 --- */
        .top-nav {
            height: var(--header-height);
            display: flex; align-items: center; justify-content: center;
            font-size: 17px; font-weight: 600;
            background: rgba(242, 242, 247, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: fixed; top: 0; width: 100%; max-width: 600px; z-index: 10;
            border-bottom: 0.5px solid rgba(0,0,0,0.1);
        }

        /* --- 主内容滚动区 --- */
        .main-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: calc(var(--header-height) + 15px) 20px calc(var(--tab-height) + var(--safe-bottom) + 20px);
            -webkit-overflow-scrolling: touch;
        }

        /* --- 学习卡片 (核心优化) --- */
        .card-wrapper {
            width: 100%;
            height: 65vh; /* 占据屏幕大部分高度 */
            perspective: 1500px;
            margin-bottom: 20px;
            position: relative;
        }

        .flashcard {
            width: 100%; height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            cursor: pointer;
        }

        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }

        .face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; /* 关键：隐藏背面 */
            -webkit-backface-visibility: hidden;
            border-radius: var(--radius);
            background: var(--card-bg);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px;
            border: 1px solid rgba(0,0,0,0.02);
        }

        /* 正面 */
        .face.front { z-index: 2; transform: rotateY(0deg); }
        .word-main { font-size: 48px; font-weight: 800; text-align: center; color: var(--text-main); margin-bottom: 10px; line-height: 1.1; word-break: break-all;}
        .word-hint { font-size: 14px; color: var(--text-sub); margin-top: 30px; background: #f2f2f7; padding: 6px 12px; border-radius: 20px;}

        /* 背面 */
        .face.back { 
            transform: rotateY(180deg); 
            z-index: 1; 
            align-items: flex-start; 
            justify-content: flex-start;
            overflow-y: auto; /* 允许背面内容滚动 */
        }
        
        .meaning-content { width: 100%; padding-top: 10px; }
        .meaning-item { 
            font-size: 20px; line-height: 1.6; color: #333; margin-bottom: 15px; 
            padding: 15px; background: #f9f9fb; border-radius: 12px;
            border-left: 5px solid var(--primary);
        }
        .small-word { font-size: 24px; font-weight: bold; color: var(--primary); margin-bottom: 20px; width: 100%; border-bottom: 1px solid #eee; padding-bottom: 10px;}

        /* --- 底部操作按钮 --- */
        .action-bar {
            position: fixed; bottom: calc(var(--tab-height) + var(--safe-bottom) + 15px);
            left: 0; right: 0; margin: 0 auto; max-width: 600px;
            padding: 0 20px;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
            z-index: 20;
        }
        .btn {
            border: none; height: 56px; border-radius: 14px; color: white; font-size: 15px; font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;
        }
        .btn span { font-size: 10px; opacity: 0.9; font-weight: normal;}
        .btn:active { transform: scale(0.95); opacity: 0.9; }

        .btn-1 { background: var(--danger); }
        .btn-2 { background: var(--warning); }
        .btn-3 { background: var(--success); }
        .btn-4 { background: var(--info); }

        /* --- 书架样式 --- */
        .book-list { display: flex; flex-direction: column; gap: 15px; }
        .book-item {
            background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            display: flex; align-items: center; transition: 0.2s; position: relative; overflow: hidden;
        }
        .book-item:active { background: #f9f9f9; transform: scale(0.99); }
        .book-item.active-book { border: 2px solid var(--primary); background: #f0f0ff; }
        
        .book-icon { width: 50px; height: 50px; background: var(--bg); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 24px; color: var(--primary);}
        .book-info h3 { margin: 0 0 5px 0; font-size: 17px; }
        .book-info p { margin: 0; font-size: 13px; color: var(--text-sub); }
        .check-mark { position: absolute; right: 20px; color: var(--primary); font-size: 24px; }

        .add-book-btn {
            margin-top: 20px; background: white; border: 2px dashed #d1d1d6; color: #8e8e93;
            width: 100%; padding: 20px; border-radius: 16px; font-size: 16px; font-weight: 600;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        /* --- 底部 Tab 导航 --- */
        .tab-bar {
            height: calc(var(--tab-height) + var(--safe-bottom));
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.1);
            position: fixed; bottom: 0; width: 100%; max-width: 600px;
            display: flex; justify-content: space-around; padding-bottom: var(--safe-bottom);
            z-index: 50;
        }
        .tab-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #aeaeB2; font-size: 10px; gap: 4px;
        }
        .tab-item i { font-size: 24px; margin-bottom: 2px; }
        .tab-item.active { color: var(--primary); }

        /* 状态页 */
        .stat-card { background: white; border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.02);}
        .stat-num { font-size: 32px; font-weight: 800; color: var(--text-main); display: block;}
        
        .empty-tip { text-align: center; color: var(--text-sub); margin-top: 50%; transform: translateY(-50%); }
    </style>
</head>
<body>
    <div id="app">
        <!-- 顶部标题 -->
        <div class="top-nav">
            <span v-if="currentTab === 'study'">{{ currentBookName || '背词神器' }}</span>
            <span v-if="currentTab === 'library'">我的书架</span>
            <span v-if="currentTab === 'stats'">学习数据</span>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            
            <!-- 1. 学习页面 -->
            <div v-if="currentTab === 'study'">
                <!-- 空状态 -->
                <div v-if="!currentBookId" class="empty-tip">
                    <i class="ri-book-mark-line" style="font-size: 64px; color: #d1d1d6; margin-bottom: 20px;"></i>
                    <p>还没有选择单词书</p>
                    <button @click="currentTab='library'" style="padding:10px 24px; background:var(--primary); color:white; border:none; border-radius:20px; font-size:15px; margin-top:10px;">去选择</button>
                </div>

                <!-- 任务完成 -->
                <div v-else-if="todayQueue.length === 0" class="empty-tip">
                    <div style="width:80px; height:80px; background:#e8f5e9; border-radius:50%; margin:0 auto 20px; display:flex; align-items:center; justify-content:center;">
                        <i class="ri-check-line" style="font-size: 40px; color: var(--success);"></i>
                    </div>
                    <h3>今日任务完成</h3>
                    <p>休息一下吧，明天继续！</p>
                </div>

                <!-- 卡片区域 -->
                <div v-else class="card-wrapper">
                    <div class="flashcard" :class="{ 'is-flipped': isFlipped }" @click="flipCard">
                        <!-- 正面 -->
                        <div class="face front">
                            <div class="word-main">{{ currentWord.word }}</div>
                            <div class="word-hint">点击查看释义</div>
                        </div>
                        <!-- 背面 -->
                        <div class="face back">
                            <div class="small-word">{{ currentWord.word }}</div>
                            <div class="meaning-content">
                                <div class="meaning-item" v-if="currentWord.meaning">{{ currentWord.meaning }}</div>
                                <div v-else style="color:#999; font-style:italic">暂无详细释义</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. 书架页面 -->
            <div v-if="currentTab === 'library'">
                <div class="book-list">
                    <div v-for="book in books" :key="book.id" 
                         class="book-item" :class="{'active-book': currentBookId === book.id}"
                         @click="switchBook(book.id)">
                        <div class="book-icon"><i class="ri-book-2-line"></i></div>
                        <div class="book-info">
                            <h3>{{ book.name }}</h3>
                            <p>共 {{ book.count }} 词 · 已完成 {{ getProgress(book.id) }}%</p>
                        </div>
                        <i v-if="currentBookId === book.id" class="ri-checkbox-circle-fill check-mark"></i>
                        <i v-else class="ri-delete-bin-line" @click.stop="deleteBook(book.id)" style="position:absolute; right:20px; color:#ff3b30; opacity:0.5; padding:10px;"></i>
                    </div>
                </div>

                <div class="add-book-btn" @click="$refs.csvInput.click()">
                    <i class="ri-add-line"></i> 导入 CSV 单词书
                </div>
                <!-- 隐藏的文件输入 -->
                <input type="file" ref="csvInput" accept=".csv" style="display:none" @change="handleCSVImport">
                
                <div style="margin-top:20px; font-size:12px; color:#999; padding:0 10px; line-height:1.5">
                    <strong>提示：</strong> CSV文件格式要求：第一列是单词，第二列是意思。不要表头。支持 UTF-8 编码。
                </div>
            </div>

            <!-- 3. 数据页面 -->
            <div v-if="currentTab === 'stats'">
                <div v-if="currentBookId">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                        <div class="stat-card">
                            <span class="stat-num" style="color:var(--success)">{{ stats.learned }}</span>
                            <span style="font-size:12px; color:#999">已掌握</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-num" style="color:var(--warning)">{{ stats.due }}</span>
                            <span style="font-size:12px; color:#999">今日待复习</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-num" style="color:var(--primary)">{{ stats.total }}</span>
                        <span style="font-size:12px; color:#999">总词汇量 ({{ currentBookName }})</span>
                    </div>
                </div>
                <div v-else class="empty-tip">请先选择一本书</div>
            </div>

        </div>

        <!-- 底部浮动按钮 (只在学习且翻面时显示) -->
        <div class="action-bar" v-if="currentTab === 'study' && isFlipped && todayQueue.length > 0">
            <button class="btn btn-1" @click.stop="rate(1)">忘记<span>1分钟</span></button>
            <button class="btn btn-2" @click.stop="rate(2)">模糊<span>10分钟</span></button>
            <button class="btn btn-3" @click.stop="rate(3)">认识<span>1天</span></button>
            <button class="btn btn-4" @click.stop="rate(4)">简单<span>4天</span></button>
        </div>

        <!-- 底部 Tab 栏 -->
        <div class="tab-bar">
            <div class="tab-item" :class="{active: currentTab==='study'}" @click="currentTab='study'">
                <i class="ri-macbook-line" v-if="currentTab!=='study'"></i>
                <i class="ri-macbook-fill" v-else></i>
                <span>学习</span>
            </div>
            <div class="tab-item" :class="{active: currentTab==='library'}" @click="currentTab='library'">
                <i class="ri-book-2-line" v-if="currentTab!=='library'"></i>
                <i class="ri-book-2-fill" v-else></i>
                <span>书架</span>
            </div>
            <div class="tab-item" :class="{active: currentTab==='stats'}" @click="currentTab='stats'">
                <i class="ri-pie-chart-2-line" v-if="currentTab!=='stats'"></i>
                <i class="ri-pie-chart-2-fill" v-else></i>
                <span>数据</span>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        // 数据库配置
        const DB_NAME = 'WordMaster_V3'; // 使用新数据库名避免冲突
        const DB_VERSION = 1;

        // 打开 IndexedDB
        const openDB = () => {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('books')) db.createObjectStore('books', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('progress')) db.createObjectStore('progress', { keyPath: 'key' });
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        };

        createApp({
            setup() {
                const currentTab = ref('study');
                const books = ref([]);
                const currentBookId = ref(localStorage.getItem('wm_curr_book_v3') || null);
                const currentBookName = ref('');
                const wordList = ref([]);
                const progressMap = ref({});
                const todayQueue = ref([]);
                const currentWord = ref(null);
                const isFlipped = ref(false);
                let db = null;

                onMounted(async () => {
                    try {
                        db = await openDB();
                        loadBooks();
                        if (currentBookId.value) loadBookData(currentBookId.value);
                    } catch (e) {
                        alert("数据库加载失败，请使用现代浏览器");
                    }
                });

                // --- 1. CSV 导入逻辑 (增强版) ---
                const handleCSVImport = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const text = e.target.result;
                        if (!text) { alert("文件内容为空"); return; }
                        
                        // 兼容不同换行符
                        const lines = text.replace(/\r\n/g, '\n').split('\n');
                        const words = [];
                        
                        lines.forEach((line) => {
                            line = line.trim();
                            if (!line) return;
                            
                            // 查找第一个逗号的位置 (支持中文逗号兼容)
                            let commaIdx = line.indexOf(',');
                            if (commaIdx === -1) commaIdx = line.indexOf('，');

                            if (commaIdx !== -1) {
                                const w = line.substring(0, commaIdx).trim();
                                let m = line.substring(commaIdx + 1).trim();
                                // 去除可能存在的引号
                                m = m.replace(/^"|"$/g, '');
                                if (w && m) {
                                    words.push({ id: w.toLowerCase(), word: w, meaning: m });
                                }
                            }
                        });

                        if (words.length === 0) {
                            alert('未能识别单词。请确保格式为：单词,意思');
                            return;
                        }

                        const bookId = Date.now().toString();
                        const newBook = {
                            id: bookId,
                            name: file.name.replace(/\.csv$/i, ''),
                            count: words.length,
                            words: words
                        };

                        const tx = db.transaction('books', 'readwrite');
                        tx.objectStore('books').put(newBook);
                        tx.oncomplete = () => {
                            loadBooks();
                            switchBook(bookId);
                            currentTab.value = 'study';
                            alert(`成功导入 ${words.length} 个单词！`);
                        };
                    };
                    reader.readAsText(file, 'UTF-8'); // 强制 UTF-8
                };

                // --- 2. 核心业务 ---
                const loadBooks = () => {
                    const tx = db.transaction('books', 'readonly');
                    tx.objectStore('books').getAll().onsuccess = (e) => {
                        books.value = e.target.result || [];
                    };
                };

                const switchBook = (id) => {
                    currentBookId.value = id;
                    localStorage.setItem('wm_curr_book_v3', id);
                    loadBookData(id);
                };

                const loadBookData = (id) => {
                    const tx = db.transaction(['books', 'progress'], 'readonly');
                    tx.objectStore('books').get(id).onsuccess = (e) => {
                        const res = e.target.result;
                        if (res) {
                            currentBookName.value = res.name;
                            wordList.value = res.words;
                            // 加载进度
                            tx.objectStore('progress').getAll().onsuccess = (ev) => {
                                const allProg = ev.target.result || [];
                                const map = {};
                                allProg.forEach(p => {
                                    if (p.key.startsWith(id + '_')) map[p.wid] = p;
                                });
                                progressMap.value = map;
                                generateQueue();
                            };
                        } else {
                            // 书可能被删了
                            currentBookId.value = null;
                        }
                    };
                };

                const generateQueue = () => {
                    const now = Date.now();
                    const newWords = [];
                    const reviewWords = [];

                    wordList.value.forEach(w => {
                        const p = progressMap.value[w.id];
                        if (!p) {
                            newWords.push(w);
                        } else if (p.due <= now) {
                            reviewWords.push(w);
                        }
                    });

                    // 优先级：先复习，后新词 (限制每次 20 个新词)
                    todayQueue.value = [...reviewWords, ...newWords.slice(0, 20)];
                    
                    if (todayQueue.value.length > 0) {
                        currentWord.value = todayQueue.value[0];
                        isFlipped.value = false;
                    }
                };

                // 翻卡
                const flipCard = () => {
                    isFlipped.value = !isFlipped.value;
                    if (isFlipped.value && currentWord.value) {
                        // 播放发音
                        const u = new SpeechSynthesisUtterance(currentWord.value.word);
                        u.lang = 'en-US';
                        window.speechSynthesis.speak(u);
                    }
                };

                // 评分 (SM-2)
                const rate = (quality) => {
                    const w = currentWord.value;
                    const pid = w.id;
                    let p = progressMap.value[pid] || { interval: 0, reps: 0, ef: 2.5 };

                    if (quality < 3) {
                        p.reps = 0;
                        p.interval = 1;
                    } else {
                        if (p.reps === 0) p.interval = 1;
                        else if (p.reps === 1) p.interval = 6;
                        else p.interval = Math.round(p.interval * p.ef);
                        p.reps++;
                        p.ef = p.ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                        if (p.ef < 1.3) p.ef = 1.3;
                    }

                    let nextDue = Date.now();
                    // 按钮逻辑：1=1min, 2=10min, 3=1day, 4=4days (简化)
                    if (quality === 1) nextDue += 60 * 1000;
                    else if (quality === 2) nextDue += 10 * 60 * 1000;
                    else if (quality === 3) nextDue += 24 * 60 * 60 * 1000;
                    else nextDue += 4 * 24 * 60 * 60 * 1000;

                    const record = { 
                        key: currentBookId.value + '_' + pid, 
                        wid: pid, 
                        due: nextDue, 
                        ...p 
                    };

                    const tx = db.transaction('progress', 'readwrite');
                    tx.objectStore('progress').put(record);
                    progressMap.value[pid] = record;

                    isFlipped.value = false;
                    todayQueue.value.shift();
                    
                    if (quality < 3) todayQueue.value.push(w); // 不认识的放队尾
                    
                    if (todayQueue.value.length > 0) {
                        currentWord.value = todayQueue.value[0];
                    }
                };

                const deleteBook = (id) => {
                    if(!confirm("确定删除？")) return;
                    const tx = db.transaction('books', 'readwrite');
                    tx.objectStore('books').delete(id);
                    tx.oncomplete = () => {
                        if(currentBookId.value === id) {
                            currentBookId.value = null;
                            todayQueue.value = [];
                        }
                        loadBooks();
                    };
                };

                // 统计
                const getProgress = (bookId) => {
                    // 这里仅做简单展示，实际需要实时计算
                    // 因为在 library 列表里无法实时获取每本书的 progressMap，所以先返回 0 或保存缓存
                    // 为了简化，这里暂不显示复杂进度，或者需要重新架构数据存储
                    return 0; 
                };

                const stats = computed(() => {
                    const total = wordList.value.length || 0;
                    const learned = Object.keys(progressMap.value).length;
                    return { total, learned, due: todayQueue.value.length };
                });

                return {
                    currentTab, books, currentBookId, currentBookName, todayQueue, currentWord, isFlipped, stats,
                    handleCSVImport, switchBook, deleteBook, flipCard, rate, getProgress
                };
            }
        }).mount('#app');

        // 注册 PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }
    </script>
</body>
</html>